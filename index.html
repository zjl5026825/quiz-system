<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºå­¦é¢˜åº“ - ä¿®å¤ç‰ˆ</title>
    <style>
        :root { --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --primary: #3b82f6; --border: #e2e8f0; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; background: var(--primary); color: white; cursor: pointer; font-weight: bold; width: 100%; margin-bottom: 10px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .bank-item { padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; }
        #debug-log { font-size: 10px; color: red; margin-top: 20px; background: #eee; padding: 10px; border-radius: 5px; display: none; }
    </style>
</head>
<body>

<div class="card">
    <h3>ğŸ“‚ é¢˜åº“ç®¡ç†</h3>
    <p style="font-size: 12px; color: #64748b;">è‹¥æ— æ³•åˆ›å»ºï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹çš„â€œå¼ºåˆ¶é‡ç½®â€æŒ‰é’®</p>
    <button class="btn" onclick="addBank()">+ ç‚¹å‡»åˆ›å»ºæ–°é¢˜åº“</button>
    <div id="bank-list">åŠ è½½æ•°æ®åº“ä¸­...</div>
    <hr style="border:0; border-top:1px solid var(--border); margin: 20px 0;">
    <button class="btn" style="background:#64748b" onclick="location.reload(true)">åˆ·æ–°é¡µé¢</button>
    <button class="btn" style="background:#ef4444" onclick="forceReset()">âš ï¸ å¼ºåˆ¶é‡ç½®æ•°æ®åº“</button>
</div>

<div id="debug-log"></div>

<script>
    // 1. å¢åŠ ç‰ˆæœ¬å·åˆ° 10ï¼Œå¼ºåˆ¶è§¦å‘ onupgradeneeded
    const DB_NAME = 'QuizMasterDB_v10'; 
    let db;

    function log(msg) {
        const el = document.getElementById('debug-log');
        el.style.display = 'block';
        el.innerHTML += `> ${msg}<br>`;
    }

    const request = indexedDB.open(DB_NAME, 10);

    request.onerror = e => {
        log("æ•°æ®åº“æ‰“å¼€å¤±è´¥: " + e.target.error.name);
        alert("æ•°æ®åº“è¢«ç¦ç”¨ï¼ˆå¯èƒ½æ˜¯æ— ç—•æ¨¡å¼ï¼‰");
    };

    request.onupgradeneeded = e => {
        log("æ£€æµ‹åˆ°ç‰ˆæœ¬æ›´æ–°ï¼Œæ­£åœ¨åˆ›å»ºå­˜å‚¨ç©ºé—´...");
        const d = e.target.result;
        if (!d.objectStoreNames.contains('banks')) {
            d.createObjectStore('banks', { keyPath: 'id', autoIncrement: true });
        }
    };

    request.onsuccess = e => {
        log("æ•°æ®åº“è¿æ¥æˆåŠŸ");
        db = e.target.result;
        renderBanks();
    };

    function renderBanks() {
        const tx = db.transaction('banks', 'readonly');
        const store = tx.objectStore('banks');
        store.getAll().onsuccess = e => {
            const list = document.getElementById('bank-list');
            const banks = e.target.result;
            if (banks.length === 0) {
                list.innerHTML = "<p style='color:#94a3b8; font-size:13px;'>æš‚æ— é¢˜åº“ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»º</p>";
            } else {
                list.innerHTML = banks.map(b => `
                    <div class="bank-item">
                        <span>${b.name} (${b.qs.length}é¢˜)</span>
                        <span style="color:red" onclick="deleteBank(${b.id})">åˆ é™¤</span>
                    </div>
                `).join('');
            }
        };
    }

    function addBank() {
        if (!db) return alert("æ•°æ®åº“å°šæœªå°±ç»ªï¼Œè¯·ç¨å");
        const name = prompt("è¯·è¾“å…¥é¢˜åº“åç§°ï¼ˆå¦‚ï¼šæ¯›æ¦‚çœŸé¢˜ï¼‰");
        if (!name) return;

        log(`æ­£åœ¨å°è¯•åˆ›å»ºé¢˜åº“: ${name}`);
        const tx = db.transaction('banks', 'readwrite');
        const store = tx.objectStore('banks');
        const newBank = { name: name, qs: [], wrongs: [] };
        
        const addReq = store.add(newBank);
        addReq.onsuccess = () => {
            log("é¢˜åº“åˆ›å»ºæˆåŠŸï¼");
            renderBanks();
        };
        addReq.onerror = e => log("åˆ›å»ºå¤±è´¥: " + e.target.error.name);
    }

    function deleteBank(id) {
        if (!confirm("ç¡®å®šåˆ é™¤å—ï¼Ÿ")) return;
        const tx = db.transaction('banks', 'readwrite');
        tx.objectStore('banks').delete(id).onsuccess = renderBanks;
    }

    function forceReset() {
        if (confirm("è¿™ä¼šæ¸…ç©ºæ‰€æœ‰é¢˜åº“ï¼Œç¡®å®šå—ï¼Ÿ")) {
            indexedDB.deleteDatabase(DB_NAME);
            localStorage.clear();
            location.reload(true);
        }
    }
</script>
</body>
</html>
