<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>智学题库 V2026.01.05.1830</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>

    <style>
        :root { --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --primary: #3b82f6; --border: #e2e8f0; }
        [data-theme="dark"] { --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --border: #334155; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; }
        .sync-check { background: #ef4444; color: white; font-size: 10px; text-align: center; padding: 4px; font-weight: bold; }
        .nav { display: flex; justify-content: space-between; padding: 12px 20px; background: var(--card); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .container { max-width: 700px; margin: 0 auto; padding: 15px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
        .option { padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-top: 10px; cursor: pointer; }
        #mg-panel { display: none; position: fixed; right: 0; top: 0; bottom: 0; width: 300px; background: var(--card); border-left: 1px solid var(--border); padding: 20px; z-index: 200; box-shadow: -2px 0 10px rgba(0,0,0,0.1); }
        .panel-open #mg-panel { display: block; }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; background: var(--primary); color: white; cursor: pointer; }
        .footer { position: fixed; bottom: 0; left: 0; right: 0; padding: 15px; background: var(--card); border-top: 1px solid var(--border); display: flex; justify-content: center; gap: 10px; }
    </style>
</head>
<body>

<div class="sync-check">
    当前运行版本：2026-01-05 18:30 | 实时模式
</div>

<div class="nav">
    <b onclick="location.reload(true)">智学题库 PRO</b>
    <button class="btn" onclick="document.body.classList.toggle('panel-open')">管理</button>
</div>

<div id="mg-panel">
    <h3>题库管理</h3>
    <button class="btn" style="width:100%" onclick="addBank()">+ 新建题库</button>
    <div id="b-list" style="margin: 15px 0;"></div>
    <input type="file" id="up" accept=".docx" style="display:none" onchange="handleFile(this)">
    <button class="btn" style="width:100%; background:#64748b" onclick="document.getElementById('up').click()">导入 Word (.docx)</button>
    <br><br>
    <button class="btn" style="width:100%; background:#ef4444" onclick="clearAllData()">⚠️ 重置所有数据</button>
</div>

<div class="container">
    <div class="card" id="q-box">请点击“管理”->“新建题库”并导入 Docx 文件</div>
</div>

<div class="footer">
    <button class="btn" style="background:#64748b" onclick="move(-1)">上一题</button>
    <button class="btn" style="flex:1" onclick="move(1)">下一题</button>
</div>

<script>
    /* 核心功能实现 */
    let db, curBank = null, pool = [], idx = 0;
    const request = indexedDB.open('QuizProSystem', 3);
    request.onupgradeneeded = e => { e.target.result.createObjectStore('banks', {keyPath:'id', autoIncrement:true}); };
    request.onsuccess = e => { db = e.target.result; loadInitial(); };

    function loadInitial() {
        refreshList();
        const id = localStorage.getItem('last_id');
        if (id) switchBank(parseInt(id));
    }

    function refreshList() {
        const tx = db.transaction('banks', 'readonly');
        tx.objectStore('banks').getAll().onsuccess = e => {
            document.getElementById('b-list').innerHTML = e.target.result.map(b => `
                <div style="padding:8px; border:1px solid var(--border); margin-top:5px; border-radius:5px; cursor:pointer;" onclick="switchBank(${b.id})">
                    ${b.name} (${b.qs.length})
                </div>
            `).join('');
        };
    }

    function switchBank(id) {
        db.transaction('banks', 'readonly').objectStore('banks').get(id).onsuccess = e => {
            curBank = e.target.result;
            if(!curBank) return;
            localStorage.setItem('last_id', id);
            pool = curBank.qs; idx = 0;
            render();
            refreshList();
        };
    }

    function render() {
        const box = document.getElementById('q-box');
        if(!pool.length) return;
        const q = pool[idx];
        let opts = q.options || [];
        if(q.type === 'judge' && !opts.length) opts = [{label:'A', content:'对'}, {label:'B', content:'错'}]; //

        box.innerHTML = `
            <div style="font-size:12px; color:#64748b">${idx+1}/${pool.length} | ${q.type}</div>
            <div style="font-size:18px; font-weight:bold; margin-top:10px">${q.question}</div>
            <div style="margin-top:15px">${opts.map(o => `<div class="option" onclick="alert('答案是：'+'${q.answer}')">${o.label}. ${o.content}</div>`).join('')}</div>
        `;
    }

    async function handleFile(input) {
        if(!curBank) return alert("请先选个题库");
        const ab = await input.files[0].arrayBuffer();
        mammoth.extractRawText({arrayBuffer:ab}).then(res => {
            const lines = res.value.split('\n').filter(l => l.trim());
            lines.forEach((l, i) => {
                const m = l.match(/^(\d+)\.\s*\[(单选题|多选题|判断题|填空题)\]\s*(.*)/);
                if(m) curBank.qs.push({id:Date.now()+i, type:m[2], question:m[3], options:[], answer:""});
            });
            db.transaction('banks', 'readwrite').objectStore('banks').put(curBank).onsuccess = () => switchBank(curBank.id);
        });
    }

    function addBank() { const n = prompt("名字:"); if(n) db.transaction('banks','readwrite').objectStore('banks').add({name:n, qs:[], wrongs:[]}).onsuccess = refreshList; }
    function move(s) { if(pool[idx+s]) { idx+=s; render(); } }
    function clearAllData() { if(confirm("清除所有本地题库？")) { indexedDB.deleteDatabase('QuizProSystem'); localStorage.clear(); location.reload(true); } }

    /* --- 核心：彻底卸载 Service Worker 逻辑 --- */
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(regs => {
            for(let r of regs) r.unregister().then(() => console.log("已强力卸载旧缓存控制器"));
        });
    }
</script>
</body>
</html>
