<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>æ™ºå­¦é¢˜åº“ Pro - V2026.01.05</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        :root { --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --primary: #3b82f6; --success: #10b981; --error: #ef4444; --border: #e2e8f0; --sub: #64748b; }
        [data-theme="dark"] { --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --primary: #60a5fa; --border: #334155; }
        * { box-sizing: border-box; transition: background 0.2s; -webkit-tap-highlight-color: transparent; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 90px; }
        
        /* åŒæ­¥çŠ¶æ€æ¡ */
        .sync-bar { background: #1e293b; color: #94a3b8; font-size: 10px; text-align: center; padding: 4px; border-bottom: 1px solid var(--border); }
        
        .nav { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; background: var(--card); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        
        /* é¢˜åº“å¡ç‰‡ */
        .card { background: var(--card); padding: 24px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-top: 10px; }
        .q-meta { font-size: 12px; color: var(--sub); margin-bottom: 10px; display: flex; justify-content: space-between; }
        .q-text { font-size: 18px; font-weight: 700; line-height: 1.5; margin-bottom: 20px; }
        
        /* é€‰é¡¹æ ·å¼ */
        .option { display: flex; align-items: center; padding: 14px; border: 2px solid var(--border); border-radius: 12px; margin-bottom: 10px; cursor: pointer; }
        .option.correct { border-color: var(--success); color: var(--success); background: rgba(16, 185, 129, 0.05); }
        .option.wrong { border-color: var(--error); color: var(--error); background: rgba(239, 68, 68, 0.05); }
        .option.selected { border-color: var(--primary); background: rgba(59, 130, 246, 0.05); }
        
        /* ç®¡ç†é¢æ¿ */
        #mg-panel { display: none; position: fixed; right: 0; top: 0; bottom: 0; width: 100%; max-width: 320px; background: var(--card); border-left: 1px solid var(--border); padding: 20px; z-index: 200; box-shadow: -5px 0 20px rgba(0,0,0,0.2); overflow-y: auto; }
        .panel-on #mg-panel { display: block; }
        
        .btn { padding: 10px 16px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; background: var(--primary); color: white; }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text); }
        
        .footer { position: fixed; bottom: 0; left: 0; right: 0; padding: 15px; background: var(--card); border-top: 1px solid var(--border); display: flex; justify-content: center; gap: 15px; z-index: 100; }
        .search-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--card); color: var(--text); margin-bottom: 15px; outline: none; }
        
        .bank-item { padding: 12px; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .bank-item.active { border-color: var(--primary); background: rgba(59, 130, 246, 0.05); }
    </style>
</head>
<body>

<div class="sync-bar">
    å½“å‰ç‰ˆæœ¬: 2026.01.05.2250 (å®æ—¶æ‹‰å–æ¨¡å¼)
</div>

<div class="nav">
    <div style="font-weight: 900; font-size: 1.1rem;" onclick="location.reload()">æ™ºå­¦é¢˜åº“ PRO</div>
    <div style="display: flex; gap: 10px;">
        <span onclick="toggleTheme()" style="cursor:pointer; font-size: 20px;">ğŸŒ“</span>
        <button class="btn btn-ghost" onclick="togglePanel()">ç®¡ç†</button>
    </div>
</div>

<div id="mg-panel">
    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
        <h3 style="margin:0">é¢˜åº“ç®¡ç†</h3>
        <button class="btn btn-ghost" onclick="togglePanel()">å…³é—­</button>
    </div>
    
    <button class="btn" style="width:100%; margin-bottom:15px" onclick="createBank()">+ æ–°å»ºé¢˜åº“</button>
    <div id="bank-list"></div>
    
    <hr style="border:0; border-top:1px solid var(--border); margin:20px 0;">
    
    <h4>å¯¼å…¥æ•°æ® (.txt / .json)</h4>
    <input type="file" id="file-up" accept=".txt,.json,.js" style="display:none" onchange="importData(this)">
    <button class="btn btn-ghost" style="width:100%" onclick="document.getElementById('file-up').click()">é€‰æ‹©æ–‡ä»¶</button>
    
    <div style="margin-top: 30px;">
        <button class="btn btn-ghost" style="width:100%; color: var(--error); border-color: var(--error);" onclick="resetEverything()">âš ï¸ æ¸…ç©ºæ‰€æœ‰æœ¬åœ°ç¼“å­˜</button>
    </div>
</div>

<div class="container">
    <input type="text" id="search" class="search-input" placeholder="å…¨å±€æœç´¢é¢˜ç›®å…³é”®è¯..." oninput="doSearch()">
    
    <div style="display: flex; gap: 8px; overflow-x: auto; margin-bottom: 15px;">
        <button class="btn btn-ghost" id="mistake-btn" onclick="toggleMistake()" style="border-color:var(--error); color:var(--error)">é”™é¢˜æœ¬ (<span id="w-count">0</span>)</button>
    </div>

    <div class="card" id="quiz-box">
        <div id="quiz-content">è¯·è¿›å…¥â€œç®¡ç†â€æ–°å»ºå¹¶é€‰æ‹©é¢˜åº“ã€‚</div>
    </div>
</div>

<div class="footer">
    <button class="btn btn-ghost" style="width: 100px" onclick="move(-1)">ä¸Šä¸€é¢˜</button>
    <button class="btn" style="flex: 1" onclick="move(1)">ä¸‹ä¸€é¢˜</button>
</div>



<script>
    /* æ ¸å¿ƒæŒä¹…åŒ–é€»è¾‘ */
    let db, curBank = null, pool = [], idx = 0, keyword = '', isMistake = false;

    // åˆå§‹åŒ– IndexedDB
    const req = indexedDB.open('QuizProSystem', 1);
    req.onupgradeneeded = e => e.target.result.createObjectStore('banks', {keyPath: 'id', autoIncrement: true});
    req.onsuccess = e => { db = e.target.result; boot(); };

    async function boot() {
        renderBanks();
        const lastId = localStorage.getItem('last_bank_id');
        if (lastId) loadBank(parseInt(lastId));
    }

    // é¢˜åº“ç®¡ç†
    function renderBanks() {
        const tx = db.transaction('banks', 'readonly');
        tx.objectStore('banks').getAll().onsuccess = e => {
            const banks = e.target.result;
            document.getElementById('bank-list').innerHTML = banks.map(b => `
                <div class="bank-item ${curBank?.id === b.id ? 'active' : ''}" onclick="loadBank(${b.id})">
                    <span>${b.name} (${b.qs.length})</span>
                    <span style="color:var(--error)" onclick="deleteBank(event, ${b.id})">ğŸ—‘ï¸</span>
                </div>
            `).join('');
        };
    }

    function loadBank(id) {
        db.transaction('banks', 'readonly').objectStore('banks').get(id).onsuccess = e => {
            curBank = e.target.result;
            if (!curBank) return;
            localStorage.setItem('last_id', id);
            isMistake = false;
            updatePool();
            renderBanks();
        };
    }

    function updatePool() {
        if (!curBank) return;
        let base = isMistake ? curBank.qs.filter(q => curBank.wrongs.includes(q.id)) : curBank.qs;
        if (keyword) base = base.filter(q => q.question.toLowerCase().includes(keyword.toLowerCase()));
        pool = base; idx = 0;
        document.getElementById('w-count').innerText = curBank.wrongs.length;
        renderQuiz();
    }

    function renderQuiz() {
        const box = document.getElementById('quiz-content');
        if (!pool.length) { box.innerHTML = `<center style="padding:40px; color:var(--sub)">æ²¡æœ‰é¢˜ç›®</center>`; return; }
        
        const q = pool[idx];
        const done = q.uAns !== undefined;
        let opts = q.options || [];
        // åˆ¤æ–­é¢˜è¡¥å…¨é€‰é¡¹
        if (q.type === 'judge' && !opts.length) opts = [{label:'A', content:'å¯¹'}, {label:'B', content:'é”™'}];

        box.innerHTML = `
            <div class="q-meta"><span>${idx+1}/${pool.length} | ${q.type}</span></div>
            <div class="q-text">${q.question.replace(new RegExp(`(${keyword})`, 'gi'), '<mark>$1</mark>')}</div>
            <div>
                ${opts.map(o => {
                    let cls = '';
                    if (done) {
                        const isR = Array.isArray(q.answer) ? q.answer.includes(o.label) : q.answer === o.label;
                        const isS = Array.isArray(q.uAns) ? q.uAns.includes(o.label) : q.uAns === o.label;
                        if(isR) cls = 'correct'; else if(isS) cls = 'wrong';
                    }
                    return `<div class="option ${cls}" onclick="handleAns('${o.label}')">${o.label}. ${o.content}</div>`;
                }).join('')}
            </div>
            ${done ? `<div style="margin-top:20px; font-size:14px; color:var(--success)"><b>ç­”æ¡ˆï¼š</b>${Array.isArray(q.answer)?q.answer.join(''):q.answer}</div>` : ''}
        `;
    }

    function handleAns(l) {
        const q = pool[idx]; if (q.uAns) return;
        q.uAns = l;
        const isR = Array.isArray(q.answer) ? (JSON.stringify(l) === JSON.stringify(q.answer)) : (l === q.answer);
        if (!isR && !curBank.wrongs.includes(q.id)) curBank.wrongs.push(q.id);
        else if (isR && isMistake) curBank.wrongs = curBank.wrongs.filter(id => id !== q.id);
        
        db.transaction('banks', 'readwrite').objectStore('banks').put(curBank);
        renderQuiz();
        document.getElementById('w-count').innerText = curBank.wrongs.length;
    }

    // å¯¼å…¥è§£æ (Txt/Json)
    async function importData(input) {
        if (!curBank) return alert("è¯·å…ˆé€‰ä¸ªé¢˜åº“");
        const file = input.files[0]; if (!file) return;
        const text = await file.text();
        let newQs = [];

        if (file.name.endsWith('.json') || file.name.endsWith('.js')) {
            try { newQs = JSON.parse(text); } catch(e) { alert("JSON æ ¼å¼é”™è¯¯"); }
        } else {
            // Txt è§£æé€»è¾‘
            const lines = text.split('\n').filter(l => l.trim());
            let cur = null;
            lines.forEach((l, i) => {
                const mQ = l.match(/^(\d+)\.\s*\[(å•é€‰é¢˜|å¤šé€‰é¢˜|åˆ¤æ–­é¢˜|å¡«ç©ºé¢˜)\]\s*(.*)/);
                if (mQ) {
                    cur = { id: Date.now()+i, type: {"å•é€‰é¢˜":"single","å¤šé€‰é¢˜":"multi","åˆ¤æ–­é¢˜":"judge"}[mQ[2]] || "single", question: mQ[3], options: [], answer: "" };
                    newQs.push(cur);
                } else if (cur) {
                    const mO = l.match(/^([A-F])\.\s*(.*)/);
                    if (mO) cur.options.push({ label: mO[1], content: mO[2] });
                    const mA = l.match(/^æ­£ç¡®ç­”æ¡ˆ[ï¼š:]\s*(.*)/);
                    if (mA) cur.answer = cur.type === 'multi' ? mA[1].trim().split('') : mA[1].trim();
                }
            });
        }
        curBank.qs = [...curBank.qs, ...newQs];
        db.transaction('banks', 'readwrite').objectStore('banks').put(curBank).onsuccess = () => loadBank(curBank.id);
    }

    function move(s) { if(pool[idx+s]) { idx+=s; renderQuiz(); } }
    function createBank() { const n = prompt("é¢˜åº“åç§°:"); if(n) db.transaction('banks','readwrite').objectStore('banks').add({name:n, qs:[], wrongs:[]}).onsuccess = renderBanks; }
    function deleteBank(e, id) { e.stopPropagation(); if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) db.transaction('banks','readwrite').objectStore('banks').delete(id).onsuccess = renderBanks; }
    function doSearch() { keyword = document.getElementById('search').value; updatePool(); }
    function toggleMistake() { isMistake = !isMistake; document.getElementById('mistake-btn').classList.toggle('btn-primary', isMistake); updatePool(); }
    function togglePanel() { document.body.classList.toggle('panel-on'); }
    function toggleTheme() { document.documentElement.setAttribute('data-theme', document.documentElement.getAttribute('data-theme')==='light'?'dark':'light'); }
    function resetEverything() { if(confirm("æ¸…é™¤æ‰€æœ‰æ•°æ®å¹¶é‡å¯ï¼Ÿ")) { indexedDB.deleteDatabase('QuizProSystem'); localStorage.clear(); location.reload(); } }

    /* --- æ ¸å¿ƒï¼šå½»åº•å¸è½½æ—§ç‰ˆæœ¬çš„ Service Worker --- */
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(regs => {
            for(let r of regs) r.unregister();
        });
    }
</script>
</body>
</html>
