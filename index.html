<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºå­¦é¢˜åº“ç®¡ç†ç³»ç»Ÿ Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <style>
        :root {
            --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --primary: #3b82f6;
            --success: #10b981; --error: #ef4444; --border: #e2e8f0; --subtext: #64748b;
        }
        [data-theme="dark"] {
            --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --primary: #60a5fa;
            --success: #34d399; --error: #fb7185; --border: #334155; --subtext: #94a3b8;
        }
        * { box-sizing: border-box; transition: background 0.2s; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        
        /* å¯¼èˆªä¸å¤´éƒ¨ */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: var(--card); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .logo { font-weight: 900; font-size: 1.2rem; cursor: pointer; }
        
        /* ä¾§è¾¹ç®¡ç†æ  */
        #management-panel { display: none; position: fixed; right: 0; top: 60px; bottom: 0; width: 350px; background: var(--card); border-left: 1px solid var(--border); padding: 20px; z-index: 101; overflow-y: auto; box-shadow: -4px 0 15px rgba(0,0,0,0.1); }
        .panel-visible #management-panel { display: block; }
        
        /* é¢˜ç›®å±•ç¤º */
        .container { max-width: 800px; margin: 20px auto; padding: 0 20px 100px; }
        .card { background: var(--card); padding: 25px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        
        /* æŒ‰é’®ä¸UIç»„ä»¶ */
        .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 13px; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-danger { background: var(--error); color: white; }

        .bank-item { padding: 12px; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 10px; cursor: pointer; display: flex; justify-content: space-between; }
        .bank-item.active { border-color: var(--primary); background: rgba(59, 130, 246, 0.1); }
        
        /* é€‰é¡¹ä¸è§£æ */
        .option { display: flex; align-items: center; padding: 12px; border: 2px solid var(--border); border-radius: 10px; margin-bottom: 8px; cursor: pointer; }
        .option.selected { border-color: var(--primary); background: rgba(59, 130, 246, 0.05); }
        .option.correct { border-color: var(--success); color: var(--success); }
        .option.wrong { border-color: var(--error); color: var(--error); }
        .analysis { margin-top: 15px; padding: 15px; background: var(--bg); border-radius: 10px; display: none; }
        .show { display: block; }

        /* æœç´¢æ¡† */
        .search-box { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); margin-bottom: 15px; }

        /* æ‰¹é‡åˆ é™¤æ ·å¼ */
        .q-list-item { display: flex; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); align-items: flex-start; }
        
        /* PWAä¸é»‘å¤œæ¨¡å¼ */
        #theme-toggle { font-size: 20px; cursor: pointer; }
    </style>
</head>
<body>

<div class="header">
    <div class="logo" onclick="location.reload()">æ™ºå­¦é¢˜åº“ Pro</div>
    <div style="display: flex; gap: 15px; align-items: center;">
        <span id="theme-toggle" onclick="toggleTheme()">ğŸŒ“</span>
        <button class="btn btn-ghost" onclick="togglePanel()">é¢˜åº“ç®¡ç†</button>
    </div>
</div>

<div id="management-panel">
    <h3>ğŸ“‚ é¢˜åº“åˆ—è¡¨</h3>
    <button class="btn btn-primary" style="width: 100%; margin-bottom: 15px;" onclick="createNewBank()">+ åˆ›å»ºæ–°é¢˜åº“</button>
    <div id="bank-list"></div>
    
    <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--border);">
    
    <h3>ğŸ“¤ ä¸Šä¼ é¢˜ç›®</h3>
    <p style="font-size: 12px; color: var(--subtext);">æ”¯æŒ .docx / .txt / .json</p>
    <input type="file" id="file-upload" accept=".docx,.txt,.json,.js" style="display: none;" onchange="handleFileUpload(this)">
    <button class="btn btn-ghost" style="width: 100%;" onclick="document.getElementById('file-upload').click()">é€‰æ‹©æ–‡ä»¶å¹¶å¯¼å…¥</button>

    <div id="batch-manager" style="margin-top: 25px; display: none;">
        <h3>æ‰¹é‡ç®¡ç† (<span id="sel-count">0</span>)</h3>
        <button class="btn btn-danger" style="width: 100%;" onclick="batchDelete()">åˆ é™¤é€‰ä¸­é¢˜ç›®</button>
        <div id="q-list-container" style="margin-top: 10px; font-size: 12px; max-height: 200px; overflow-y: auto;"></div>
    </div>
</div>

<div class="container">
    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <input type="text" id="search" class="search-box" style="margin: 0;" placeholder="å…¨å±€æœç´¢å½“å‰é¢˜åº“..." oninput="handleSearch()">
        <button class="btn btn-ghost" onclick="toggleMistakeMode()" id="mistake-btn">é”™é¢˜æœ¬ (<span id="w-count">0</span>)</button>
    </div>

    <div class="card">
        <div id="quiz-area">è¯·å…ˆåœ¨ç®¡ç†é¢æ¿ä¸­é€‰æ‹©æˆ–å¯¼å…¥ä¸€ä¸ªé¢˜åº“</div>
    </div>

    <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px;">
        <button class="btn btn-ghost" onclick="move(-1)">â† ä¸Šä¸€é¢˜</button>
        <button class="btn btn-primary" style="padding: 10px 40px;" onclick="move(1)">ä¸‹ä¸€é¢˜ â†’</button>
    </div>
</div>

<script>
/* ==========================================
   1. æ•°æ®åº“æ¨¡å— (IndexedDB)
   ========================================== */
const DB_NAME = 'QuizDB';
const STORE_NAME = 'Banks';
let db;

const initDB = () => {
    return new Promise((resolve) => {
        const request = indexedDB.open(DB_NAME, 1);
        request.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
            }
        };
        request.onsuccess = (e) => { db = e.target.result; resolve(); };
    });
};

const saveBank = async (bank) => {
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    return store.put(bank);
};

const getAllBanks = () => {
    return new Promise((resolve) => {
        const tx = db.transaction(STORE_NAME, 'readonly');
        tx.objectStore(STORE_NAME).getAll().onsuccess = (e) => resolve(e.target.result);
    });
};

const deleteBankFromDB = (id) => {
    const tx = db.transaction(STORE_NAME, 'readwrite');
    tx.objectStore(STORE_NAME).delete(id);
};

/* ==========================================
   2. æ ¸å¿ƒé€»è¾‘æ¨¡å—
   ========================================== */
let activeBank = null;
let filteredPool = [];
let currIdx = 0;
let isMistakeMode = false;
let searchQuery = '';

async function init() {
    await initDB();
    refreshBankList();
    const lastId = localStorage.getItem('last_bank_id');
    if (lastId) loadBank(parseInt(lastId));
}

async function createNewBank() {
    const name = prompt("è¯·è¾“å…¥æ–°é¢˜åº“åç§°ï¼š", "æˆ‘çš„é¢˜åº“");
    if (!name) return;
    const newBank = { name, questions: [], wrongs: [] };
    const request = await saveBank(newBank);
    request.onsuccess = () => refreshBankList();
}

async function refreshBankList() {
    const banks = await getAllBanks();
    const list = document.getElementById('bank-list');
    list.innerHTML = banks.map(b => `
        <div class="bank-item ${activeBank?.id === b.id ? 'active' : ''}" onclick="loadBank(${b.id})">
            <span>${b.name} (${b.questions.length})</span>
            <span style="color:var(--error)" onclick="removeBank(event, ${b.id})">ğŸ—‘ï¸</span>
        </div>
    `).join('');
}

async function loadBank(id) {
    const banks = await getAllBanks();
    activeBank = banks.find(b => b.id === id);
    if (!activeBank) return;
    localStorage.setItem('last_bank_id', id);
    isMistakeMode = false;
    applyFilter();
    refreshBankList();
    renderBatchList();
}

function removeBank(e, id) {
    e.stopPropagation();
    if (!confirm("ç¡®å®šåˆ é™¤æ•´ä¸ªé¢˜åº“å—ï¼Ÿä¸å¯æ¢å¤ï¼")) return;
    deleteBankFromDB(id);
    if (activeBank?.id === id) activeBank = null;
    refreshBankList();
}

/* ==========================================
   3. æ–‡ä»¶è§£ææ¨¡å— (Mammoth.js + Regex)
   ========================================== */
async function handleFileUpload(input) {
    if (!activeBank) return alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé¢˜åº“å†å¯¼å…¥");
    const file = input.files[0];
    if (!file) return;

    let text = "";
    if (file.name.endsWith('.docx')) {
        const arrayBuffer = await file.arrayBuffer();
        const result = await mammoth.extractRawText({ arrayBuffer });
        text = result.value;
    } else {
        text = await file.text();
    }

    const newQs = parseText(text);
    activeBank.questions = [...activeBank.questions, ...newQs];
    await saveBank(activeBank);
    loadBank(activeBank.id);
    alert(`æˆåŠŸå¯¼å…¥ ${newQs.length} é“é¢˜ç›®ï¼`);
}

function parseText(text) {
    const qs = [];
    const lines = text.split('\n').map(l => l.trim()).filter(l => l);
    
    // ç®€å•çš„æ­£åˆ™åŒ¹é…é€»è¾‘ (åŸºäºä¹‹å‰çš„ Python è„šæœ¬)
    const reQ = /^(\d+)\.\s*\[(å•é€‰é¢˜|å¤šé€‰é¢˜|åˆ¤æ–­é¢˜|å¡«ç©ºé¢˜)\]\s*(.*)/;
    const reOpt = /^([A-F])\.\s*(.*)/;
    const reAns = /^æ­£ç¡®ç­”æ¡ˆ[ï¼š:]\s*(.*)/;

    let current = null;
    const typeMap = {"å•é€‰é¢˜":"single", "å¤šé€‰é¢˜":"multi", "åˆ¤æ–­é¢˜":"judge", "å¡«ç©ºé¢˜":"fill"};

    lines.forEach((line, i) => {
        const mQ = line.match(reQ);
        if (mQ) {
            current = { id: Date.now() + i, type: typeMap[mQ[2]], question: mQ[3], options: [], answer: "" };
            qs.push(current);
        } else if (current && current.type !== 'fill') {
            const mO = line.match(reOpt);
            if (mO) current.options.push({ label: mO[1], content: mO[2] });
            const mAn = line.match(reAns);
            if (mAn) {
                const ans = mAn[1].trim();
                current.answer = current.type === 'multi' ? ans.split('') : ans;
            }
        } else if (current && current.type === 'fill') {
            const mAn = line.match(reAns);
            if (mAn) current.answer = mAn[1].trim();
        }
    });
    return qs;
}

/* ==========================================
   4. æ¸²æŸ“ä¸äº¤äº’æ¨¡å—
   ========================================== */
function applyFilter() {
    if (!activeBank) return;
    let base = isMistakeMode ? activeBank.questions.filter(q => activeBank.wrongs.includes(q.id)) : activeBank.questions;
    if (searchQuery) base = base.filter(q => q.question.includes(searchQuery));
    filteredPool = base;
    currIdx = 0;
    document.getElementById('w-count').innerText = activeBank.wrongs.length;
    renderQuiz();
}

function renderQuiz() {
    const area = document.getElementById('quiz-area');
    if (!filteredPool.length) { area.innerHTML = "å½“å‰é¢˜åº“/åˆ†ç±»ä¸‹æ²¡æœ‰é¢˜ç›®"; return; }
    
    const q = filteredPool[currIdx];
    const done = q.userAns !== undefined;
    
    // åˆ¤æ–­é¢˜è‡ªåŠ¨é€»è¾‘
    let opts = q.options;
    if (q.type === 'judge' && !opts.length) opts = [{label:'A', content:'å¯¹'}, {label:'B', content:'é”™'}];

    area.innerHTML = `
        <div style="font-size:12px; color:var(--subtext); margin-bottom:10px;">${currIdx+1} / ${filteredPool.length}</div>
        <div style="font-weight:bold; font-size:18px; margin-bottom:20px;">${q.question}</div>
        <div>
            ${opts.map(o => {
                let cls = '';
                if(done) {
                    const isR = Array.isArray(q.answer) ? q.answer.includes(o.label) : q.answer === o.label;
                    const isS = Array.isArray(q.userAns) ? q.userAns.includes(o.label) : q.userAns === o.label;
                    if(isR) cls = 'correct'; else if(isS) cls = 'wrong';
                }
                return `<div class="option ${cls}" onclick="handleSel('${o.label}')">${o.label}. ${o.content}</div>`;
            }).join('')}
        </div>
        <div class="analysis ${done?'show':''}"><b>ç­”æ¡ˆï¼š</b> ${Array.isArray(q.answer)?q.answer.join(''):q.answer}</div>
    `;
}

function handleSel(l) {
    const q = filteredPool[currIdx];
    if (q.userAns) return;
    q.userAns = l;
    
    // åˆ¤åˆ†
    const isR = Array.isArray(q.answer) ? (JSON.stringify(l) === JSON.stringify(q.answer)) : (l === q.answer);
    if (!isR && !activeBank.wrongs.includes(q.id)) activeBank.wrongs.push(q.id);
    if (isR && isMistakeMode) activeBank.wrongs = activeBank.wrongs.filter(id => id !== q.id);
    
    saveBank(activeBank);
    renderQuiz();
    document.getElementById('w-count').innerText = activeBank.wrongs.length;
}

/* ==========================================
   5. æ‰¹é‡ç®¡ç†æ¨¡å—
   ========================================== */
function renderBatchList() {
    const panel = document.getElementById('batch-manager');
    const container = document.getElementById('q-list-container');
    if (!activeBank) { panel.style.display = 'none'; return; }
    
    panel.style.display = 'block';
    container.innerHTML = activeBank.questions.map(q => `
        <div class="q-list-item">
            <input type="checkbox" class="q-checkbox" value="${q.id}" onchange="updateBatchCount()">
            <span>${q.question.substring(0, 30)}...</span>
        </div>
    `).join('');
}

function updateBatchCount() {
    const count = document.querySelectorAll('.q-checkbox:checked').length;
    document.getElementById('sel-count').innerText = count;
}

async function batchDelete() {
    const ids = Array.from(document.querySelectorAll('.q-checkbox:checked')).map(cb => parseInt(cb.value));
    if (!ids.length || !confirm(`ç¡®å®šåˆ é™¤è¿™ ${ids.length} é“é¢˜ç›®å—ï¼Ÿ`)) return;
    
    activeBank.questions = activeBank.questions.filter(q => !ids.includes(q.id));
    activeBank.wrongs = activeBank.wrongs.filter(id => !ids.includes(id));
    await saveBank(activeBank);
    loadBank(activeBank.id);
}

/* ==========================================
   6. UIè¾…åŠ©åŠŸèƒ½
   ========================================== */
function togglePanel() { document.body.classList.toggle('panel-visible'); }
function toggleTheme() { document.documentElement.setAttribute('data-theme', document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light'); }
function move(s) { if(filteredPool[currIdx+s]) { currIdx += s; renderQuiz(); } }
function handleSearch() { searchQuery = document.getElementById('search').value; applyFilter(); }
function toggleMistakeMode() { isMistakeMode = !isMistakeMode; document.getElementById('mistake-btn').classList.toggle('btn-primary', isMistakeMode); applyFilter(); }

window.onload = init;
</script>
</body>
</html>