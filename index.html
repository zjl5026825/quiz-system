<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºå­¦é¢˜åº“ Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ™ºå­¦é¢˜åº“">
    <link rel="apple-touch-icon" href="icon.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>

    <style>
        :root { --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --primary: #3b82f6; --success: #10b981; --error: #ef4444; --border: #e2e8f0; --subtext: #64748b; }
        [data-theme="dark"] { --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --primary: #60a5fa; --success: #34d399; --error: #fb7185; --border: #334155; --subtext: #94a3b8; }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; min-height: 100vh; }
        .nav { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; background: var(--card); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .container { max-width: 700px; margin: 0 auto; padding: 20px; padding-bottom: 100px; }
        #mg-panel { display: none; position: fixed; right: 0; top: 0; bottom: 0; width: 320px; background: var(--card); border-left: 1px solid var(--border); padding: 20px; z-index: 200; box-shadow: -5px 0 20px rgba(0,0,0,0.1); overflow-y: auto; }
        .panel-on #mg-panel { display: block; }
        .card { background: var(--card); padding: 24px; border-radius: 16px; border: 1px solid var(--border); }
        .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; background: var(--primary); color: white; }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .option { display: flex; align-items: center; padding: 14px; border: 2px solid var(--border); border-radius: 12px; margin-bottom: 10px; cursor: pointer; }
        .option.selected { border-color: var(--primary); background: rgba(59, 130, 246, 0.05); }
        .option.correct { border-color: var(--success); color: var(--success); }
        .option.wrong { border-color: var(--error); color: var(--error); }
        .analysis { margin-top: 20px; padding: 15px; background: var(--bg); border-radius: 12px; display: none; border-left: 4px solid var(--primary); }
        .show { display: block; }
        .search-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--card); color: var(--text); margin-bottom: 15px; }
        .footer { position: fixed; bottom: 0; left: 0; right: 0; padding: 15px; background: var(--card); border-top: 1px solid var(--border); display: flex; justify-content: center; gap: 15px; }
        .tab { padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border); cursor: pointer; font-size: 13px; background: var(--card); }
        .tab.active { background: var(--primary); color: white; }
    </style>
</head>
<body>

<div class="nav">
    <div style="font-weight: 900; font-size: 1.1rem;" onclick="location.reload()">æ™ºå­¦é¢˜åº“ PRO</div>
    <div style="display: flex; gap: 12px; align-items: center;">
        <span onclick="toggleMode()" style="cursor:pointer; font-size: 20px;">ğŸŒ“</span>
        <button class="btn btn-ghost" onclick="togglePanel()">ç®¡ç†</button>
    </div>
</div>

<div id="mg-panel">
    <h3>é¢˜åº“ç®¡ç†</h3>
    <button class="btn" style="width:100%; margin-bottom:15px" onclick="addBank()">+ æ–°å»ºé¢˜åº“</button>
    <div id="b-list"></div>
    <hr style="border:0; border-top:1px solid var(--border); margin:20px 0;">
    <input type="file" id="up" accept=".docx" style="display:none" onchange="importFile(this)">
    <button class="btn btn-ghost" style="width:100%" onclick="document.getElementById('up').click()">å¯¼å…¥ Docx é¢˜åº“</button>
</div>

<div class="container">
    <input type="text" id="srch" class="search-input" placeholder="å…¨å±€æœç´¢..." oninput="doSearch()">
    <div style="display: flex; gap: 8px; margin-bottom: 10px; overflow-x: auto;">
        <div class="tab active" onclick="setTab('all')">å…¨éƒ¨</div>
        <div class="tab" onclick="setTab('single')">å•é€‰</div>
        <div class="tab" onclick="setTab('multi')">å¤šé€‰</div>
        <div class="tab" onclick="setTab('judge')">åˆ¤æ–­</div>
        <div class="tab" id="mistake-tab" onclick="toggleMistake()" style="color:var(--error)">é”™é¢˜ (<span id="w-n">0</span>)</div>
    </div>
    <div class="card" id="main-card"><div id="quiz">åŠ è½½ä¸­...</div></div>
</div>

<div class="footer">
    <button class="btn btn-ghost" style="width:100px" onclick="move(-1)">ä¸Šä¸€é¢˜</button>
    <button class="btn" style="flex:1" onclick="move(1)">ä¸‹ä¸€é¢˜</button>
</div>

<script>
    let db, curBank = null, pool = [], idx = 0, filter = 'all', keyword = '', mistakeMode = false;
    const req = indexedDB.open('QuizProDB', 1);
    req.onupgradeneeded = e => e.target.result.createObjectStore('banks', {keyPath:'id', autoIncrement:true});
    req.onsuccess = e => { db = e.target.result; startup(); };

    async function startup() {
        refreshBanks();
        const id = localStorage.getItem('last_id');
        if (id) loadBank(parseInt(id));
    }

    async function refreshBanks() {
        const tx = db.transaction('banks', 'readonly');
        tx.objectStore('banks').getAll().onsuccess = e => {
            document.getElementById('b-list').innerHTML = e.target.result.map(b => `
                <div style="padding:10px; border:1px solid var(--border); margin-bottom:5px; border-radius:8px; display:flex; justify-content:space-between" onclick="loadBank(${b.id})">
                    ${b.name} (${b.qs.length}) <span style="color:red" onclick="delBank(event, ${b.id})">ğŸ—‘ï¸</span>
                </div>
            `).join('');
        };
    }

    async function loadBank(id) {
        db.transaction('banks', 'readonly').objectStore('banks').get(id).onsuccess = e => {
            curBank = e.target.result;
            localStorage.setItem('last_id', id);
            apply();
            refreshBanks();
        };
    }

    function apply() {
        if (!curBank) return;
        let b = mistakeMode ? curBank.qs.filter(q => curBank.wrongs.includes(q.id)) : curBank.qs;
        if (filter !== 'all') b = b.filter(q => q.type === filter);
        if (keyword) b = b.filter(q => q.question.toLowerCase().includes(keyword));
        pool = b; idx = 0;
        document.getElementById('w-n').innerText = curBank.wrongs.length;
        render();
    }

    function render() {
        const qz = document.getElementById('quiz');
        if (!pool.length) { qz.innerHTML = 'æ— é¢˜ç›®'; return; }
        const q = pool[idx], done = q.uAns !== undefined;
        let opts = q.options || [];
        if (q.type === 'judge' && !opts.length) opts = [{label:'A', content:'å¯¹'}, {label:'B', content:'é”™'}];
        qz.innerHTML = `
            <div style="font-size:12px; color:var(--subtext)">${idx+1}/${pool.length} | ${q.type}</div>
            <div style="font-size:18px; font-weight:700; margin:15px 0;">${q.question}</div>
            ${opts.map(o => {
                let c = '';
                if(done) {
                    const isR = Array.isArray(q.answer) ? q.answer.includes(o.label) : q.answer === o.label;
                    const isS = Array.isArray(q.uAns) ? q.uAns.includes(o.label) : q.uAns === o.label;
                    if(isR) c = 'correct'; else if(isS) c = 'wrong';
                }
                return `<div class="option ${c}" onclick="doSel('${o.label}')">${o.label}. ${o.content}</div>`;
            }).join('')}
            <div class="analysis ${done?'show':''}">ç­”æ¡ˆï¼š${Array.isArray(q.answer)?q.answer.join(''):q.answer}</div>
        `;
    }

    function doSel(l) {
        const q = pool[idx]; if (q.uAns) return;
        q.uAns = l;
        const isR = Array.isArray(q.answer) ? (JSON.stringify(l) === JSON.stringify(q.answer)) : (l === q.answer);
        if (!isR && !curBank.wrongs.includes(q.id)) curBank.wrongs.push(q.id);
        db.transaction('banks', 'readwrite').objectStore('banks').put(curBank);
        render();
    }

    async function importFile(input) {
        const file = input.files[0]; if (!file || !curBank) return;
        const ab = await file.arrayBuffer();
        mammoth.extractRawText({ arrayBuffer: ab }).then(res => {
            const lines = res.value.split('\n').filter(l => l.trim());
            let cur = null;
            lines.forEach((l, i) => {
                const mQ = l.match(/^(\d+)\.\s*\[(å•é€‰é¢˜|å¤šé€‰é¢˜|åˆ¤æ–­é¢˜|å¡«ç©ºé¢˜)\]\s*(.*)/);
                if (mQ) {
                    cur = { id: Date.now() + i, type: {"å•é€‰é¢˜":"single","å¤šé€‰é¢˜":"multi","åˆ¤æ–­é¢˜":"judge"}[mQ[2]], question: mQ[3], options: [], answer: "" };
                    curBank.qs.push(cur);
                } else if (cur) {
                    const mO = l.match(/^([A-F])\.\s*(.*)/);
                    if (mO) cur.options.push({ label: mO[1], content: mO[2] });
                    const mA = l.match(/^æ­£ç¡®ç­”æ¡ˆ[ï¼š:]\s*(.*)/);
                    if (mA) cur.answer = cur.type === 'multi' ? mA[1].trim().split('') : mA[1].trim();
                }
            });
            db.transaction('banks', 'readwrite').objectStore('banks').put(curBank).onsuccess = () => loadBank(curBank.id);
        });
    }

    function move(s) { if(pool[idx+s]) { idx += s; render(); } }
    function addBank() { const n = prompt("åç§°:"); if(n) db.transaction('banks','readwrite').objectStore('banks').add({name:n, qs:[], wrongs:[]}).onsuccess = refreshBanks; }
    function delBank(e, id) { e.stopPropagation(); if(confirm("åˆ é™¤ï¼Ÿ")) db.transaction('banks','readwrite').objectStore('banks').delete(id).onsuccess = refreshBanks; }
    function setTab(t) { filter = t; apply(); }
    function toggleMistake() { mistakeMode = !mistakeMode; apply(); }
    function doSearch() { keyword = document.getElementById('srch').value.toLowerCase(); apply(); }
    function togglePanel() { document.body.classList.toggle('panel-on'); }
    function toggleMode() { document.documentElement.setAttribute('data-theme', document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light'); }

    // ==========================================
    // ğŸ“¢ æœ€ç»ˆç‰ˆåŒæ­¥é€»è¾‘ï¼šä½¿ç”¨é™æ€ç‰ˆæœ¬å· 1.0.3
    // ==========================================
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            const VERSION = '1.0.3'; 
            // æ³¨å†Œ SW å¹¶é™„å¸¦ç‰ˆæœ¬å·æŸ¥è¯¢å­—ç¬¦ä¸²
            navigator.serviceWorker.register(`sw.js?v=${VERSION}`).then(reg => {
                reg.onupdatefound = () => {
                    const worker = reg.installing;
                    worker.onstatechange = () => {
                        if (worker.state === 'installed' && navigator.serviceWorker.controller) {
                            if (confirm("å‘ç°æ–°ç‰ˆæœ¬ï¼ˆ1.0.3ï¼‰ï¼Œç‚¹å‡»ç¡®å®šç«‹å³æ›´æ–°ç³»ç»Ÿã€‚")) {
                                location.reload();
                            }
                        }
                    };
                };
            });
        });
    }
</script>
</body>
</html>
