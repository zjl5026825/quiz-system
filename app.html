<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºå­¦é¢˜åº“ Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ™ºå­¦é¢˜åº“">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>

    <style>
        :root {
            --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --primary: #3b82f6;
            --success: #10b981; --error: #ef4444; --border: #e2e8f0; --subtext: #64748b;
        }
        [data-theme="dark"] {
            --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --primary: #60a5fa;
            --success: #34d399; --error: #fb7185; --border: #334155; --subtext: #94a3b8;
        }
        * { box-sizing: border-box; transition: background 0.2s, color 0.2s; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; min-height: 100vh; -webkit-user-select: none; }
        
        .nav { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; background: var(--card); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .container { max-width: 700px; margin: 0 auto; padding: 20px; padding-bottom: 100px; }
        
        /* ç®¡ç†é¢æ¿ */
        #mg-panel { display: none; position: fixed; right: 0; top: 0; bottom: 0; width: 320px; background: var(--card); border-left: 1px solid var(--border); padding: 20px; z-index: 200; box-shadow: -5px 0 20px rgba(0,0,0,0.1); overflow-y: auto; }
        .panel-on #mg-panel { display: block; }
        
        .card { background: var(--card); padding: 24px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 13px; background: var(--primary); color: white; }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text); }
        
        .tab { padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border); cursor: pointer; font-size: 13px; background: var(--card); white-space: nowrap; }
        .tab.active { background: var(--primary); color: white; border-color: var(--primary); }

        .option { display: flex; align-items: center; padding: 14px; border: 2px solid var(--border); border-radius: 12px; margin-bottom: 10px; cursor: pointer; }
        .option.selected { border-color: var(--primary); background: rgba(59, 130, 246, 0.05); }
        .option.correct { border-color: var(--success); color: var(--success); background: rgba(16, 185, 129, 0.05); }
        .option.wrong { border-color: var(--error); color: var(--error); background: rgba(239, 68, 68, 0.05); }
        .opt-key { width: 24px; height: 24px; border-radius: 6px; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 800; margin-right: 12px; border: 1px solid var(--border); }

        .analysis { margin-top: 20px; padding: 15px; background: var(--bg); border-radius: 12px; display: none; border-left: 4px solid var(--primary); }
        .show { display: block; }

        .search-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--card); color: var(--text); margin-bottom: 15px; outline: none; }
        .footer { position: fixed; bottom: 0; left: 0; right: 0; padding: 15px; background: var(--card); border-top: 1px solid var(--border); display: flex; justify-content: center; gap: 15px; z-index: 150; }
    </style>
</head>
<body class="panel-on">

<div class="nav">
    <div style="font-weight: 900; font-size: 1.1rem;">æ™ºå­¦é¢˜åº“ PRO</div>
    <div style="display: flex; gap: 12px; align-items: center;">
        <span onclick="toggleMode()" style="cursor:pointer; font-size: 20px;">ğŸŒ“</span>
        <button class="btn btn-ghost" onclick="togglePanel()">ç®¡ç†</button>
    </div>
</div>

<div id="mg-panel">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin:0">é¢˜åº“ç®¡ç†</h3>
        <button class="btn btn-ghost" onclick="togglePanel()">å…³é—­</button>
    </div>
    <button class="btn" style="width:100%; margin-bottom:15px" onclick="addBank()">+ æ–°å»ºé¢˜åº“</button>
    <div id="b-list"></div>
    <hr style="border:0; border-top:1px solid var(--border); margin:20px 0;">
    <h4>å¯¼å…¥é¢˜ç›®</h4>
    <input type="file" id="up" accept=".docx,.txt" style="display:none" onchange="importFile(this)">
    <button class="btn btn-ghost" style="width:100%" onclick="document.getElementById('up').click()">ä¸Šä¼ æ–‡ä»¶ (.docx)</button>
    <div id="batch-del" style="margin-top:20px; display:none">
        <h4>æ‰¹é‡ç®¡ç† (<span id="sel-n">0</span>)</h4>
        <button class="btn" style="background:var(--error); width:100%" onclick="doBatchDel()">åˆ é™¤é€‰ä¸­</button>
        <div id="q-manage-list" style="max-height:150px; overflow-y:auto; font-size:12px; margin-top:10px"></div>
    </div>
</div>

<div class="container">
    <input type="text" id="srch" class="search-input" placeholder="è¾“å…¥å…³é”®è¯æœç´¢é¢˜ç›®..." oninput="doSearch()">
    <div style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 15px; margin-bottom: 10px;">
        <div class="tab active" onclick="setTab('all')">å…¨éƒ¨</div>
        <div class="tab" onclick="setTab('single')">å•é€‰</div>
        <div class="tab" onclick="setTab('multi')">å¤šé€‰</div>
        <div class="tab" onclick="setTab('judge')">åˆ¤æ–­</div>
        <div class="tab" onclick="setTab('fill')">å¡«ç©º</div>
        <div class="tab" id="mistake-tab" onclick="toggleMistake()" style="border-color:var(--error); color:var(--error)">é”™é¢˜ (<span id="w-n">0</span>)</div>
    </div>
    <div class="card" id="main-card">
        <div id="quiz">è¯·åœ¨ç®¡ç†é¢æ¿ä¸­é€‰æ‹©æˆ–å¯¼å…¥é¢˜åº“</div>
    </div>
</div>

<div class="footer">
    <button class="btn btn-ghost" style="width:100px" onclick="move(-1)">ä¸Šä¸€é¢˜</button>
    <button class="btn" style="flex:1; max-width:200px" onclick="move(1)">ä¸‹ä¸€é¢˜</button>
</div>

<script>
    let db;
    const req = indexedDB.open('QuizProDB', 1);
    req.onupgradeneeded = e => e.target.result.createObjectStore('banks', {keyPath:'id', autoIncrement:true});
    req.onsuccess = e => { db = e.target.result; startup(); };

    let curBank = null, pool = [], idx = 0, filter = 'all', keyword = '', mistakeMode = false;

    async function startup() {
        refreshBanks();
        const id = localStorage.getItem('last_id');
        if (id) loadBank(parseInt(id));
    }

    async function refreshBanks() {
        const tx = db.transaction('banks', 'readonly');
        tx.objectStore('banks').getAll().onsuccess = e => {
            const list = document.getElementById('b-list');
            list.innerHTML = e.target.result.map(b => `
                <div class="bank-item ${curBank?.id === b.id ? 'active' : ''}" onclick="loadBank(${b.id})">
                    <span>${b.name} (${b.qs.length})</span>
                    <span style="color:var(--error)" onclick="delBank(event, ${b.id})">ğŸ—‘ï¸</span>
                </div>
            `).join('');
        };
    }

    async function loadBank(id) {
        const tx = db.transaction('banks', 'readonly');
        tx.objectStore('banks').get(id).onsuccess = e => {
            curBank = e.target.result;
            if (!curBank) return;
            localStorage.setItem('last_id', id);
            mistakeMode = false;
            apply();
            refreshBanks();
            drawBatch();
        };
    }

    function apply() {
        if (!curBank) return;
        let b = mistakeMode ? curBank.qs.filter(q => curBank.wrongs.includes(q.id)) : curBank.qs;
        if (filter !== 'all') b = b.filter(q => q.type === filter);
        if (keyword) b = b.filter(q => q.question.toLowerCase().includes(keyword));
        pool = b; idx = 0;
        document.getElementById('w-n').innerText = curBank.wrongs.length;
        render();
    }

    function render() {
        const qz = document.getElementById('quiz');
        if (!pool.length) { qz.innerHTML = '<center style="padding:40px; color:var(--subtext)">æš‚æ— é¢˜ç›®</center>'; return; }
        const q = pool[idx], done = q.uAns !== undefined;
        let opts = q.options || [];
        if (q.type === 'judge' && !opts.length) opts = [{label:'A', content:'å¯¹'}, {label:'B', content:'é”™'}];
        qz.innerHTML = `
            <div style="font-size:12px; color:var(--subtext); margin-bottom:10px;">${idx+1}/${pool.length} | ${q.type}</div>
            <div style="font-size:18px; font-weight:700; margin-bottom:20px; line-height:1.6">${q.question.replace(new RegExp(`(${keyword})`, 'gi'), '<mark>$1</mark>')}</div>
            ${opts.map((o, i) => {
                let c = '';
                if(done) {
                    const isR = Array.isArray(q.answer) ? q.answer.includes(o.label) : q.answer === o.label;
                    const isS = Array.isArray(q.uAns) ? q.uAns.includes(o.label) : q.uAns === o.label;
                    if(isR) c = 'correct'; else if(isS) c = 'wrong';
                } else if(q.tmp?.includes(o.label)) c = 'selected';
                return `<div class="option ${c}" onclick="doSel('${o.label}')"><div class="opt-key">${i+1}</div>${o.content}</div>`;
            }).join('')}
            <div class="analysis ${done?'show':''}"><b>ç­”æ¡ˆï¼š</b>${Array.isArray(q.answer)?q.answer.join(''):q.answer}</div>
        `;
    }

    function doSel(l) {
        const q = pool[idx]; if (q.uAns) return;
        if (q.type === 'multi') {
            if(!q.tmp) q.tmp = [];
            const p = q.tmp.indexOf(l); p > -1 ? q.tmp.splice(p, 1) : q.tmp.push(l);
            render();
        } else {
            q.uAns = l; judge(q); render();
        }
    }

    function judge(q) {
        const isR = Array.isArray(q.answer) ? (JSON.stringify(q.uAns.sort()) === JSON.stringify(q.answer.sort())) : (q.uAns === q.answer);
        if (!isR) { if(!curBank.wrongs.includes(q.id)) curBank.wrongs.push(q.id); }
        else if (mistakeMode) curBank.wrongs = curBank.wrongs.filter(id => id !== q.id);
        const tx = db.transaction('banks', 'readwrite'); tx.objectStore('banks').put(curBank);
        document.getElementById('w-n').innerText = curBank.wrongs.length;
    }

    async function importFile(input) {
        if (!curBank) return alert("è¯·å…ˆé€‰ä¸ªé¢˜åº“");
        const file = input.files[0]; if (!file) return;
        let txt = "";
        if (file.name.endsWith('.docx')) {
            const ab = await file.arrayBuffer();
            const res = await mammoth.extractRawText({ arrayBuffer: ab });
            txt = res.value;
        } else { txt = await file.text(); }
        const newQs = parse(txt);
        curBank.qs = [...curBank.qs, ...newQs];
        const tx = db.transaction('banks', 'readwrite');
        tx.objectStore('banks').put(curBank).onsuccess = () => { loadBank(curBank.id); alert("å¯¼å…¥æˆåŠŸï¼"); };
    }

    function parse(t) {
        const res = [];
        const lines = t.split('\n').map(l => l.trim()).filter(l => l);
        let cur = null;
        lines.forEach((l, i) => {
            const mQ = l.match(/^(\d+)\.\s*\[(å•é€‰é¢˜|å¤šé€‰é¢˜|åˆ¤æ–­é¢˜|å¡«ç©ºé¢˜)\]\s*(.*)/);
            if (mQ) {
                cur = { id: Date.now() + i, type: {"å•é€‰é¢˜":"single","å¤šé€‰é¢˜":"multi","åˆ¤æ–­é¢˜":"judge","å¡«ç©ºé¢˜":"fill"}[mQ[2]], question: mQ[3], options: [], answer: "" };
                res.push(cur);
            } else if (cur) {
                const mO = l.match(/^([A-F])\.\s*(.*)/);
                if (mO) cur.options.push({ label: mO[1], content: mO[2] });
                const mA = l.match(/^æ­£ç¡®ç­”æ¡ˆ[ï¼š:]\s*(.*)/);
                if (mA) cur.answer = cur.type === 'multi' ? mA[1].trim().split('') : mA[1].trim();
            }
        });
        return res;
    }

    window.onkeydown = e => {
        const q = pool[idx]; if (!q) return;
        if (e.key >= '1' && e.key <= '4' && q.type !== 'fill') doSel(['A','B','C','D'][e.key-1]);
        if (e.key === 'ArrowLeft') move(-1);
        if (e.key === 'ArrowRight') move(1);
        if (e.key === 'Enter') {
            if (q.type === 'multi' && !q.uAns && q.tmp?.length) { q.uAns = q.tmp; judge(q); render(); }
            else if (q.uAns) move(1);
        }
    };

    function move(s) { if(pool[idx+s]) { idx += s; render(); } }
    function addBank() { const n = prompt("åå­—:"); if(n) { const tx = db.transaction('banks','readwrite'); tx.objectStore('banks').add({name:n, qs:[], wrongs:[]}).onsuccess = refreshBanks; } }
    function delBank(e, id) { e.stopPropagation(); if(confirm("åˆ ï¼Ÿ")) { const tx = db.transaction('banks','readwrite'); tx.objectStore('banks').delete(id).onsuccess = refreshBanks; } }
    function setTab(t) { filter = t; document.querySelectorAll('.tab').forEach(el => el.classList.toggle('active', el.innerText.includes(t)|| (t==='all'&&el.innerText==='å…¨éƒ¨'))); apply(); }
    function toggleMistake() { mistakeMode = !mistakeMode; document.getElementById('mistake-tab').classList.toggle('active', mistakeMode); apply(); }
    function doSearch() { keyword = document.getElementById('srch').value.toLowerCase(); apply(); }
    function togglePanel() { document.body.classList.toggle('panel-on'); }
    function toggleMode() { document.documentElement.setAttribute('data-theme', document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light'); }
    function drawBatch() {
        const c = document.getElementById('q-manage-list'); document.getElementById('batch-del').style.display = 'block';
        c.innerHTML = curBank.qs.map(q => `<div style="display:flex;gap:5px"><input type="checkbox" class="qb" value="${q.id}" onchange="document.getElementById('sel-n').innerText=document.querySelectorAll('.qb:checked').length"> ${q.question.slice(0,15)}...</div>`).join('');
    }
    function doBatchDel() {
        const ids = Array.from(document.querySelectorAll('.qb:checked')).map(i => parseInt(i.value));
        if(!ids.length) return;
        curBank.qs = curBank.qs.filter(q => !ids.includes(q.id));
        curBank.wrongs = curBank.wrongs.filter(id => !ids.includes(id));
        const tx = db.transaction('banks', 'readwrite'); tx.objectStore('banks').put(curBank).onsuccess = () => loadBank(curBank.id);
    }

    // ==========================================
    // ğŸ“¢ é™æ€ç‰ˆæœ¬æ§åˆ¶ï¼šæœç»æ­»å¾ªç¯å¼¹çª—
    // ==========================================
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            const VERSION = '1.0.2'; // åªæœ‰ä½ æƒ³å¼ºåˆ¶åˆ·æ–°æ‰‹æœºç¼“å­˜æ—¶ï¼Œæ‰æ‰‹åŠ¨æ”¹è¿™ä¸ªæ•°å­—
            navigator.serviceWorker.register(`sw.js?v=${VERSION}`).then(reg => {
                reg.onupdatefound = () => {
                    const worker = reg.installing;
                    worker.onstatechange = () => {
                        if (worker.state === 'installed' && navigator.serviceWorker.controller) {
                            if (confirm("å‘ç°ç³»ç»Ÿç‰ˆæœ¬æ›´æ–°ï¼Œæ˜¯å¦ç«‹å³åˆ·æ–°åº”ç”¨ï¼Ÿ")) {
                                location.reload();
                            }
                        }
                    };
                };
            });
        });
    }
</script>
</body>
</html>
